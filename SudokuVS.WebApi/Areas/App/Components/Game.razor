@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JsRuntime
@inject ISudokuGamesRepository Repository
@using Microsoft.AspNetCore.Components.Authorization
@using SudokuVS.Game
@using SudokuVS.Game.Models
@using SudokuVS.Game.Persistence
@using SudokuVS.Game.Users
@implements IDisposable

@if (_instance != null)
{
    <div class="container-lg py-3">
        <GameSummaryComponent Game="_instance"></GameSummaryComponent>
        <hr/>
    </div>


    <div class="w-100 h-100 d-flex flex-column">
        <div class="w-100 flex-grow-1 d-flex align-items-stretch">
            <div class="w-50 border-end border-secondary-subtle pt-4">
                @if (_player1HiddenState == null)
                {
                    @if (_playerState == null)
                    {
                        // Player is not the game, they can join as player 1
                        <div class="w-100 h-100 d-flex align-items-center justify-content-center">
                            <button class="btn btn-outline-primary" @onclick="JoinAsPlayer1">Join</button>
                        </div>
                    }
                    else
                    {
                        // Player is in the game, this side is empty and waiting for an opponent
                        <div class="w-100 h-100 d-flex flex-column gap-2 align-items-center justify-content-center">
                            <h3>No opponent has joined yet!</h3>
                            <div class="w-50 position-relative d-flex flex-column gap-2 border border-secondary-subtle rounded p-2 px-4 wrap-anywhere">
                                <div id="invitation-link-container" class="font-monospace text-secondary">
                                    @GetOtherPlayerInvitationLink()
                                </div>
                                <a class="btn btn-outline-primary my-2 stretched-link" @onclick="CopyInvitationLinkAsync" id="copy-invitation-link-button">Copy invitation link</a>
                            </div>
                        </div>
                    }
                }
                else
                {
                    @if (_playerState is { Side: PlayerSide.Player1 })
                    {
                        @if (_instance.IsStarted)
                        {
                            <CurrentPlayerComponent State="_playerState" RightToLeft></CurrentPlayerComponent>
                        }
                        else
                        {
                            <OtherPlayerComponent State="_player1HiddenState" RightToLeft></OtherPlayerComponent>
                        }
                    }
                    else
                    {
                        <OtherPlayerComponent State="_player1HiddenState" RightToLeft></OtherPlayerComponent>
                    }
                }
            </div>
            <div class="w-50 pt-4">
                @if (_player2HiddenState == null)
                {
                    @if (_playerState == null)
                    {
                        // Player is not the game, they can join as player 2
                        <div class="w-100 h-100 d-flex align-items-center justify-content-center">
                            <button class="btn btn-outline-primary" @onclick="JoinAsPlayer2">Join</button>
                        </div>
                    }
                    else
                    {
                        // Player is in the game, this side is empty and waiting for an opponent
                        <div class="w-100 h-100 d-flex flex-column gap-2 align-items-center justify-content-center">
                            <h3>No opponent has joined yet!</h3>
                            <div class="w-50 position-relative d-flex flex-column gap-2 border border-secondary-subtle rounded p-2 px-4 wrap-anywhere">
                                <div id="invitation-link-container" class="font-monospace text-secondary">
                                    @GetOtherPlayerInvitationLink()
                                </div>
                                <a class="btn btn-outline-primary my-2 stretched-link" @onclick="CopyInvitationLinkAsync" id="copy-invitation-link-button">Copy invitation link</a>
                            </div>
                        </div>
                    }
                }
                else
                {
                    @if (_playerState is { Side: PlayerSide.Player2 })
                    {
                        @if (_instance.IsStarted)
                        {
                            <CurrentPlayerComponent State="_playerState"></CurrentPlayerComponent>
                        }
                        else
                        {
                            <OtherPlayerComponent State="_player2HiddenState"></OtherPlayerComponent>
                        }
                    }
                    else
                    {
                        <OtherPlayerComponent State="_player2HiddenState"></OtherPlayerComponent>
                    }
                }
            </div>
        </div>
    </div>
}
else
{
    <div class="w-100 h-100 d-flex flex-column align-items-center justify-content-center">
        <div class="text-danger">Game not found</div>
        <a href="/">Go back</a>
    </div>
}

@code {

    [Parameter]
    public string? GameId { get; set; }

    UserIdentity? _user;
    SudokuGame? _instance;
    PlayerState? _playerState;
    IHiddenPlayerState? _player1HiddenState;
    IHiddenPlayerState? _player2HiddenState;
    Timer? _timer;

    IJSObjectReference? _gameModule;

    protected override async Task OnInitializedAsync()
    {
        if (GameId == null || !Guid.TryParse(GameId, out Guid gameId))
        {
            return;
        }

        AuthenticationState authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _user = authState.User.GetUserIdentity();
        if (_user == null)
        {
            return;
        }

        _instance = await Repository.GetAsync(gameId);
        if (_instance == null)
        {
            return;
        }

        _instance.PlayerJoined += OnPlayerJoined;
        _instance.GameOver += OnGameOver;

        UpdatePlayers();

        _timer = new Timer(__ => _ = InvokeAsync(StateHasChanged), null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    void UpdatePlayers()
    {
        if (_instance == null)
        {
            _player1HiddenState = null;
            _player2HiddenState = null;
            _playerState = null;
            return;
        }

        _player1HiddenState = _instance.GetHiddenPlayerState(PlayerSide.Player1);
        _player2HiddenState = _instance.GetHiddenPlayerState(PlayerSide.Player2);

        if (_user == null)
        {
            _playerState = null;
            return;
        }

        _playerState = _instance.GetPlayerState(_user.ExternalId);
    }

    void JoinAsPlayer1()
    {
        if (_instance == null || _user == null)
        {
            return;
        }

        _instance.Join(_user, PlayerSide.Player1);
    }

    void JoinAsPlayer2()
    {
        if (_instance == null || _user == null)
        {
            return;
        }

        _instance.Join(_user, PlayerSide.Player2);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        _gameModule ??= await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./Areas/App/Components/Game.razor.js");
    }

    public void Dispose()
    {
        if (_instance is not null)
        {
            _instance.PlayerJoined -= OnPlayerJoined;
        }

        _timer?.Dispose();
    }

    void OnPlayerJoined(object? __, PlayerSide side) =>
        _ = InvokeAsync(
            () =>
            {
                UpdatePlayers();
                StateHasChanged();
            }
        );

    void OnGameOver(object? __, PlayerSide ___) => _ = InvokeAsync(StateHasChanged);

    string GetOtherPlayerInvitationLink() => _instance == null ? "" : $"{Navigation.BaseUri}game/{_instance.Id}";

    async Task CopyInvitationLinkAsync()
    {
        if (_gameModule == null)
        {
            return;
        }

        await _gameModule.InvokeVoidAsync("copyInvitationLink", GetOtherPlayerInvitationLink());
    }

}